<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>DNS 一致性检查工具</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        h1 { color: #333; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input[type="text"], textarea, select { 
            width: 100%; 
            padding: 8px; 
            margin-top: 5px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            box-sizing: border-box; 
        }
        textarea { height: 150px; resize: vertical; }
        button { 
            background-color: #007bff; 
            color: white; 
            padding: 10px 15px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-top: 15px; 
            margin-right: 10px;
        }
        button.action-btn { background-color: #28a745; margin-top: 5px; padding: 5px 10px; }
        button.delete-btn { background-color: #dc3545; margin-top: 5px; padding: 5px 10px; }
        button:hover { background-color: #0056b3; }
        button.action-btn:hover { background-color: #1e7e34; }
        button.delete-btn:hover { background-color: #c82333; }
        
        .list-manager { border: 1px dashed #ccc; padding: 10px; margin-bottom: 20px; border-radius: 4px; }
        .list-controls { display: flex; align-items: flex-end; gap: 10px; }
        .tip { font-size: 0.85em; color: #6c757d; margin-top: 5px; } /* 新增的提示样式 */
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        .inconsistent {
            color: red;
            font-weight: bold;
            background-color: #ffeaea;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>DNS 一致性检查工具</h1>
    
    <div class="list-manager">
        <label for="serverListSelector">选择已保存的服务器列表:</label>
        
        <p class="tip">
            ❗ **注意：** 所有服务器列表和配置信息均保存在**当前浏览器的本地存储 (LocalStorage)**，只对当前用户和浏览器生效。清除浏览器缓存将导致列表丢失。
        </p>
        
        <div class="list-controls">
            <select id="serverListSelector" style="width: 50%;" onchange="loadSelectedList()"></select>
            
            <input type="text" id="newListName" placeholder="输入列表名称以保存当前列表" style="width: 30%; height: 35px;">
            <button class="action-btn" type="button" onclick="saveCurrentList()" style="margin-top: 0;">保存当前列表</button>
            <button class="delete-btn" type="button" onclick="deleteSelectedList()" style="margin-top: 0;">删除选中列表</button>
        </div>
    </div>

    <form method="POST" id="mainForm">
        <label for="domain">要查询的域名 (如: www.example.com):</label>
        <input type="text" id="domain" name="domain" 
               value="{{ domain if domain else '' }}" required>
        
        <label for="dns_servers">DNS 服务器 IP 列表 (每行一个 IP):</label>
        <textarea id="dns_servers" name="dns_servers" required>{{ dns_servers if dns_servers else '192.168.1.1\n192.168.1.2\n8.8.8.8' }}</textarea>
        
        <button type="submit">开始检查</button>
    </form>

    {% if results %}
        <h2>检查结果：{{ domain }}</h2>
        <table>
            <thead>
                <tr>
                    <th>DNS 服务器</th>
                    <th>解析结果 (A 记录)</th>
                    <th>一致性状态</th>
                </tr>
            </thead>
            <tbody>
                {% for item in results %}
                <tr class="{% if item.status == 'inconsistent' %}inconsistent{% endif %}">
                    <td>{{ item.server }}</td>
                    <td>{{ item.result }}</td>
                    <td>
                        {% if item.status == 'inconsistent' %}
                            <span class="inconsistent">❌ 不一致</span>
                        {% else %}
                            ✅ 一致
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}
</div>

<script>
    const STORAGE_KEY = 'dnsServerLists';
    const SELECTED_KEY = 'selectedListName'; // 新增：保存选中的列表名称
    const serverListSelector = document.getElementById('serverListSelector');
    const dnsServersTextarea = document.getElementById('dns_servers');
    const newListNameInput = document.getElementById('newListName');
    const mainForm = document.getElementById('mainForm');
    
    // --- 核心 LocalStorage 逻辑 ---
    
    function getSavedLists() {
        const lists = localStorage.getItem(STORAGE_KEY);
        try {
            return lists ? JSON.parse(lists) : {};
        } catch (e) {
            console.error("无法解析保存的列表数据", e);
            return {};
        }
    }
    
    function saveListsToStorage(lists) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(lists));
    }
    
    /**
     * 填充下拉菜单并尝试选中上次使用的列表
     * @param {object} lists - 包含所有列表的对象
     */
    function populateSelector(lists) {
        // 尝试从 LocalStorage 获取上次选中的名称
        const selectedNameOnLoad = localStorage.getItem(SELECTED_KEY);
        
        // 清空现有选项
        serverListSelector.innerHTML = '<option value="">-- 选择列表 --</option>';
        
        let shouldLoadList = false;
        
        for (const name in lists) {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            
            // 检查是否是上次选中的列表
            if (name === selectedNameOnLoad) {
                option.selected = true;
                shouldLoadList = true;
            }
            
            serverListSelector.appendChild(option);
        }
        
        // 页面加载时，如果找到了上次选中的列表，自动加载内容到文本域
        if (shouldLoadList) {
            loadSelectedList(selectedNameOnLoad);
        }
    }
    
    /**
     * 加载下拉菜单中选中的服务器列表到文本域
     * @param {string} listName - 可选，用于从外部指定加载哪个列表
     */
    window.loadSelectedList = function(listName = null) {
        const selectedName = listName || serverListSelector.value;
        if (!selectedName) {
            // 如果选中了 "-- 选择列表 --" 或列表为空，则不操作
            return;
        }
        
        const lists = getSavedLists();
        const listContent = lists[selectedName];
        
        if (listContent) {
            dnsServersTextarea.value = listContent;
            // 无论如何，只要加载了列表，就保存它的名字，解决问题 1
            localStorage.setItem(SELECTED_KEY, selectedName); 
            console.log(`已加载并记录列表: ${selectedName}`);
        }
    };
    
    /**
     * 将当前文本域中的内容保存为一个新列表
     */
    window.saveCurrentList = function() {
        const listName = newListNameInput.value.trim();
        const listContent = dnsServersTextarea.value.trim();
        
        if (!listName) {
            alert("请输入列表名称！");
            newListNameInput.focus();
            return;
        }
        if (!listContent) {
            alert("DNS 服务器列表不能为空！");
            return;
        }
        
        const lists = getSavedLists();
        lists[listName] = listContent;
        
        saveListsToStorage(lists);
        // 自动选中并记录新保存的列表
        localStorage.setItem(SELECTED_KEY, listName);
        populateSelector(lists); 
        
        newListNameInput.value = ''; // 清空名称输入框
        alert(`列表 "${listName}" 已保存！`);
    };

    /**
     * 删除下拉菜单中选中的列表
     */
    window.deleteSelectedList = function() {
        const selectedName = serverListSelector.value;
        if (!selectedName) {
            alert("请先选择一个要删除的列表！");
            return;
        }
        
        if (confirm(`确定要删除列表 "${selectedName}" 吗？`)) {
            const lists = getSavedLists();
            delete lists[selectedName];
            saveListsToStorage(lists);
            
            // 如果删除了当前选中的列表，则清空记录
            if (localStorage.getItem(SELECTED_KEY) === selectedName) {
                localStorage.removeItem(SELECTED_KEY);
            }
            
            // 清空文本域并重新填充下拉菜单
            dnsServersTextarea.value = ''; 
            populateSelector(lists);
            alert(`列表 "${selectedName}" 已删除！`);
        }
    };
    
    /**
     * 页面加载时执行：读取所有列表并填充下拉菜单，并尝试恢复上次选择
     */
    function initializeListManager() {
        const lists = getSavedLists();
        populateSelector(lists);
    }

    // --- 提交前记录选中项的逻辑 (确保提交后也能恢复) ---
    mainForm.addEventListener('submit', function() {
        const selectedName = serverListSelector.value;
        if (selectedName) {
            localStorage.setItem(SELECTED_KEY, selectedName);
        } else {
            // 如果用户选择了 "-- 选择列表 --"，则清除记录
            localStorage.removeItem(SELECTED_KEY);
        }
    });

    // 页面完全加载后初始化
    document.addEventListener('DOMContentLoaded', initializeListManager);

</script>

</body>
</html>
